# 主控制器模块

<cite>
**本文档引用的文件**
- [script.js](file://script.js)
- [ai-module.js](file://ai-module.js)
- [command-module.js](file://command-module.js)
- [effects.js](file://effects.js)
- [prompts.js](file://prompts.js)
- [index.html](file://index.html)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
`script.js` 文件是 work-timer 应用的核心控制中枢，负责协调 AI 功能、视觉特效、命令控制等子模块。该模块通过全局变量管理、DOM 事件绑定、用户交互处理、状态维护、数据持久化（localStorage）以及跨模块协调，构建了应用的启动流程和运行逻辑。

## 项目结构
work-timer 应用的项目结构清晰，主要文件包括 `script.js`、`ai-module.js`、`command-module.js`、`effects.js`、`prompts.js` 和 `index.html`。这些文件共同构成了应用的核心功能。

## 核心组件
`script.js` 文件作为主控制器模块，负责初始化应用、管理全局状态、处理用户交互和协调子模块。

**Section sources**
- [script.js](file://script.js#L1-L3151)

## 架构概述
`script.js` 模块通过 `initApp`、`initTabs`、`initClockIn` 等初始化函数构建应用启动流程，并通过 `window` 对象暴露这些函数，实现模块间的协调。

```mermaid
graph TD
A[script.js] --> B[initApp]
A --> C[initTabs]
A --> D[initClockIn]
A --> E[initPomodoro]
A --> F[initAISettings]
A --> G[initCommandControl]
B --> H[加载全局变量]
C --> I[绑定标签页事件]
D --> J[绑定打卡按钮事件]
E --> K[绑定番茄钟事件]
F --> L[绑定AI设置事件]
G --> M[绑定命令控制事件]
```

**Diagram sources**
- [script.js](file://script.js#L94-L1205)

## 详细组件分析

### 主控制器分析
`script.js` 模块作为主控制器，通过全局变量管理应用状态，通过 DOM 事件绑定处理用户交互，通过 `localStorage` 实现数据持久化，并通过调用 `window.AIModule`、`window.ClockEffects` 和 `window.CommandModule` 等全局模块接口，协调 AI 功能、视觉特效和命令控制。

#### 对于对象导向的组件：
```mermaid
classDiagram
class ScriptJS {
+events : Array
+workStartTime : string
+lunchStartTime : string
+lunchEndTime : string
+workEndTime : string
+holidays : Object
+workdaysOff : Object
+weekendsWork : Object
+activeTab : string
+developerMode : boolean
+customTime : string
+todayTimeline : Array
+workTimeConfig : Object
+initApp() : void
+initTabs() : void
+initClockIn() : void
+initPomodoro() : void
+initAISettings() : void
+initCommandControl() : void
+loadTodayTimeline() : void
+saveTodayTimeline() : void
+addTimelineEvent(type, content, extraData) : Object
+getCurrentTime() : Date
+switchTab(tabId) : void
+updateClockInButton() : void
+startPomodoro(minutes) : void
+updatePomodoroDisplay() : void
+completePomodoro() : void
+resetPomodoroUI() : void
+displayMoyuFortune(fortuneData) : void
+displayWorkSummary() : void
}
class AIModule {
+getAIGreeting(type) : Promise
+getMoyuFortune() : Promise
+generateWorkSummary(workData) : Promise
+callAIAnalysis(promptType, content) : Promise
}
class ClockEffects {
+playSunshine() : void
+playFireworks() : void
+clear() : void
}
class CommandModule {
+processCommand(userCommand) : Promise
+executeCommand(commandType, params) : Object
}
ScriptJS --> AIModule : "调用"
ScriptJS --> ClockEffects : "调用"
ScriptJS --> CommandModule : "调用"
```

**Diagram sources**
- [script.js](file://script.js#L1-L3151)
- [ai-module.js](file://ai-module.js#L1-L216)
- [effects.js](file://effects.js#L1-L279)
- [command-module.js](file://command-module.js#L1-L313)

#### 对于 API/服务组件：
```mermaid
sequenceDiagram
participant User as "用户"
participant ScriptJS as "script.js"
participant AIModule as "window.AIModule"
participant ClockEffects as "window.ClockEffects"
participant CommandModule as "window.CommandModule"
User->>ScriptJS : 点击打卡按钮
ScriptJS->>ScriptJS : 记录打卡时间
ScriptJS->>ClockEffects : playSunshine() / playFireworks()
ScriptJS->>AIModule : getAIGreeting(type)
ScriptJS->>AIModule : getMoyuFortune() / generateWorkSummary()
ScriptJS->>ScriptJS : 显示问候语和摸鱼吉日签/工作总结
ScriptJS->>CommandModule : processCommand(userCommand)
ScriptJS->>ScriptJS : 执行相应操作
ScriptJS-->>User : 显示结果
```

**Diagram sources**
- [script.js](file://script.js#L547-L728)
- [ai-module.js](file://ai-module.js#L66-L167)
- [effects.js](file://effects.js#L26-L86)
- [command-module.js](file://command-module.js#L185-L250)

#### 对于复杂逻辑组件：
```mermaid
flowchart TD
Start([开始]) --> CheckFirstVisit["检查是否首次使用"]
CheckFirstVisit --> |是| ShowSetupModal["显示首次设置弹窗"]
CheckFirstVisit --> |否| InitApp["初始化应用"]
ShowSetupModal --> SaveWorkTime["保存工作时间"]
SaveWorkTime --> InitApp
InitApp --> InitTabs["初始化标签页"]
InitApp --> InitSidebar["初始化侧边栏"]
InitApp --> InitPomodoro["初始化番茄钟"]
InitApp --> InitAISettings["初始化AI设置"]
InitApp --> InitClockIn["初始化打卡功能"]
InitApp --> InitTimeline["初始化时间轴"]
InitApp --> InitCommandControl["初始化AI指令控制"]
InitApp --> InitShortcuts["初始化快捷功能"]
InitApp --> InitCalendarEvents["初始化日历事件功能"]
InitTabs --> BindTabEvents["绑定标签页事件"]
InitClockIn --> BindClockInEvents["绑定打卡按钮事件"]
InitPomodoro --> BindPomodoroEvents["绑定番茄钟事件"]
InitAISettings --> BindAISettingsEvents["绑定AI设置事件"]
InitCommandControl --> BindCommandControlEvents["绑定命令控制事件"]
BindTabEvents --> End([结束])
BindClockInEvents --> End
BindPomodoroEvents --> End
BindAISettingsEvents --> End
BindCommandControlEvents --> End
```

**Diagram sources**
- [script.js](file://script.js#L94-L145)

### 概念概述
`script.js` 模块通过 `initApp` 函数初始化应用，加载全局变量，绑定事件处理程序，并协调子模块的初始化。

## 依赖分析
`script.js` 模块依赖于 `ai-module.js`、`command-module.js`、`effects.js` 和 `prompts.js` 等子模块，通过 `window` 对象暴露的接口进行调用。

```mermaid
graph TD
A[script.js] --> B[ai-module.js]
A --> C[command-module.js]
A --> D[effects.js]
A --> E[prompts.js]
B --> F[DeepSeek API]
C --> G[AI 分析]
D --> H[Canvas 特效]
E --> I[Prompt 模板]
```

**Diagram sources**
- [script.js](file://script.js#L94-L1205)
- [ai-module.js](file://ai-module.js#L1-L216)
- [command-module.js](file://command-module.js#L1-L313)
- [effects.js](file://effects.js#L1-L279)
- [prompts.js](file://prompts.js#L1-L159)

## 性能考虑
`script.js` 模块通过 `setInterval` 定时更新倒计时，通过 `localStorage` 实现数据持久化，通过异步调用 AI 接口避免阻塞主线程。

## 故障排除指南
如果应用无法正常启动，请检查 `script.js` 文件是否正确加载，检查 `localStorage` 中的配置是否正确，检查 AI API 密钥是否有效。

**Section sources**
- [script.js](file://script.js#L94-L1205)
- [ai-module.js](file://ai-module.js#L424-L491)

## 结论
`script.js` 模块作为 work-timer 应用的核心控制中枢，通过协调 AI 功能、视觉特效、命令控制等子模块，实现了应用的启动流程和运行逻辑。该模块通过全局变量管理、DOM 事件绑定、用户交互处理、状态维护、数据持久化和跨模块协调，构建了一个功能丰富、用户体验良好的应用。