# 更新日志

所有重要的更新和变更都会记录在此文件中。

## [v1.4.1] - 2024-12-12

### 新增功能

#### 1. 沉浸式阅读模式
- **专注模式切换**: 在阅读器顶部添加"专注模式"按钮,一键开启/关闭
- **自动隐藏工具栏**: 开启专注模式后,工具栏自动隐藏,鼠标移动到顶部时显示
- **淡化辅助元素**: 进度条和底部导航栏透明度降低,减少干扰
- **状态持久化**: 专注模式状态保存到localStorage,刷新页面后保持

#### 2. 文本标注功能增强
- **多色高亮标记**:
  - 支持5种高亮颜色:黄色、绿色、蓝色、粉色、紫色
  - 右键菜单新增"选择颜色"子菜单
  - 鼠标悬停显示颜色选择器
  - 高亮内容持久化存储,支持跨会话恢复
  
- **高亮笔记功能**:
  - 选中文本后可添加个人笔记
  - 带笔记的高亮文本显示📝图标
  - 笔记内容与高亮文本关联存储
  - 支持查看和编辑笔记
  
- **高亮管理面板**:
  - 新增"查看高亮"按钮,查看书籍的所有高亮和笔记
  - 支持按类型筛选:全部/高亮/笔记
  - 显示高亮颜色、章节位置、时间戳
  - 点击高亮项可跳转到对应章节

#### 3. AI问书功能
- **右键菜单扩展**: 
  - 新增"问AI"选项,快速提问
  - 自动提取选中文本及上下文
  
- **智能上下文提取**:
  - 自动获取选中文本所在段落
  - 提取前后各一个段落作为上下文
  - 为AI提供完整的语境信息
  
- **AI问答交互**:
  - 专门的AI问答弹窗,清晰展示上下文
  - 使用DeepSeek API进行语义理解
  - 支持Markdown格式的回答展示
  - 提供"继续提问"功能,支持追问
  - loading动画,实时反馈处理状态
  
- **问答记录管理**:
  - 自动保存所有问答记录
  - 按书籍和章节组织存储
  - 支持将AI解释保存为笔记
  - 方便用户回顾和复习

### 技术实现

#### 前端架构
- **模块化设计**: 
  - BookshelfManager类负责书架和UI管理
  - Reader类负责阅读器核心功能
  - 清晰的职责分离,易于维护
  
- **事件系统**:
  - 专注模式切换事件
  - 颜色选择子菜单交互
  - 笔记弹窗管理
  - AI问答弹窗管理
  - 高亮管理弹窗
  
- **数据持久化**:
  - localStorage存储高亮数据(reader_highlights)
  - localStorage存储笔记数据(reader_notes)
  - localStorage存储问答历史(reader_ask_history)
  - localStorage存储专注模式状态(reader_focus_mode)

#### AI集成
- **Prompt设计**:
  - 新增BOOK_ASK提示词模板
  - 使用占位符动态替换上下文
  - 明确的回答要求和长度限制
  
- **API调用**:
  - 复用项目现有的AIModule
  - 调用callDeepSeekAPI函数
  - 参数:maxTokens=500, temperature=0.7
  - 完善的错误处理和降级机制

#### UI/UX优化
- **CSS增强**:
  - 专注模式样式(transform, opacity)
  - 多色高亮样式(.highlight.yellow/.green等)
  - 笔记图标样式(.has-note::after)
  - AI问答弹窗样式
  - 笔记弹窗样式
  - 高亮管理弹窗样式
  - loading动画(@keyframes spin)
  
- **交互体验**:
  - 平滑的过渡动画
  - 直观的颜色选择
  - 清晰的提示反馈
  - 便捷的快捷操作

### 数据结构

#### 高亮数据
```javascript
{
  "bookId": {
    "chapterIndex": [
      {
        "text": "高亮文本",
        "color": "yellow",
        "timestamp": "2024-12-12T10:00:00.000Z"
      }
    ]
  }
}
```

#### 笔记数据
```javascript
{
  "bookId": {
    "chapterIndex": [
      {
        "reference": "引用的原文",
        "note": "笔记内容",
        "chapter": 0,
        "timestamp": "2024-12-12T10:00:00.000Z"
      }
    ]
  }
}
```

#### 问答历史
```javascript
{
  "bookId": {
    "chapterIndex": [
      {
        "selectedText": "选中的文本",
        "context": {
          "prev": "前一段",
          "current": "当前段",
          "next": "后一段"
        },
        "question": "用户的问题",
        "answer": "AI的回答",
        "chapter": 0,
        "timestamp": "2024-12-12T10:00:00.000Z"
      }
    ]
  }
}
```

### 文件变更

#### 新增
- 无新增文件(所有功能集成到现有模块)

#### 修改
- `reader/index.html`: 添加专注模式按钮、查看高亮按钮、右键菜单扩展、AI问答弹窗、笔记弹窗、高亮管理弹窗
- `reader/styles.css`: 添加371行新样式代码
- `reader/script.js`: 添加约450行JavaScript逻辑
- `reader/reader.js`: 添加约160行核心功能
- `prompts.js`: 添加BOOK_ASK提示词
- `index.html`: 更新版本号v1.4.0 → v1.4.1

### 使用说明

#### 专注模式
1. 点击阅读器顶部的"🎯"按钮开启专注模式
2. 工具栏会自动隐藏,将鼠标移到顶部可临时显示
3. 再次点击关闭专注模式

#### 多色高亮
1. 选中文本后右键
2. 选择"选择颜色"
3. 在子菜单中选择喜欢的颜色
4. 高亮会立即应用并保存

#### 添加笔记
1. 选中文本后右键
2. 选择"添加笔记"
3. 在弹窗中输入笔记内容
4. 点击"保存"

#### AI问书
1. 选中难懂的文本后右键
2. 选择"问AI"
3. AI会自动提取上下文并给出解释
4. 可以在弹窗中继续提问
5. 可以将AI解释保存为笔记

#### 查看高亮
1. 点击阅读器顶部的"📖"按钮
2. 查看该书籍的所有高亮和笔记
3. 可以按类型筛选(全部/高亮/笔记)
4. 点击任意高亮项可跳转到对应章节

### 注意事项
- AI问书功能需要先在设置中配置DeepSeek API密钥
- 高亮和笔记数据存储在浏览器localStorage中
- 清除浏览器缓存会导致数据丢失
- 建议定期导出重要笔记

---

## [v1.4.0] - 2024-12-11

### 新增功能
- **电子书阅读器**: 完整的读书模块,支持txt和epub格式
- **书架管理**: 书籍导入、删除、进度追踪
- **阅读设置**: 字体大小、主题切换、翻页模式
- **阅读进度**: 自动保存和恢复阅读位置
- **基础标注**: 文本高亮和复制功能

### 技术实现
- 独立的reader模块目录
- BookshelfManager和Reader类
- localStorage数据持久化
- 响应式设计

---

## [v1.3.0] - 2024-12-05

### 新增功能
- **AI自然语言指令**: 支持通过自然语言控制应用
- **指令识别**: DeepSeek大模型理解用户意图
- **批量操作**: 支持复杂指令和批量操作
- **智能反馈**: 实时显示执行结果

---

## [v1.2.0] - 2024-11-20

### 新增功能
- **网上冲浪模块**: 微博热搜、抖音热榜聚合
- **AI读报功能**: 人民日报分析和解读
- **时间轴功能**: 记录和展示所有事件
- **番茄钟优化**: UI重构和交互改进

---

## [v1.1.0] - 2024-11-15

### 新增功能
- **打卡系统**: 上班/下班打卡
- **AI问候**: 摸鱼吉日签
- **工资进度**: 实时显示工资进度
- **假期倒计时**: 距离下个假期的天数

---

## [v1.0.0] - 2024-11-10

### 初始版本
- **基础框架**: 页面布局和导航
- **本地存储**: localStorage数据管理
- **响应式设计**: 移动端适配
- **主题系统**: 基础主题支持
